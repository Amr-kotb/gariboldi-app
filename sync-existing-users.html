<!DOCTYPE html>
<html>
<head>
    <title>Sincronizza Utenti Esistenti</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .user { margin: 10px; padding: 10px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>üîÑ Sincronizza Utenti Esistenti da Firebase</h2>
    <p>Questo script crea documenti Firestore per utenti gi√† in Firebase Auth.</p>
    
    <button onclick="syncUsers()">üîÑ Sincronizza Tutti gli Utenti</button>
    <button onclick="checkExistingUsers()">üëÅÔ∏è Visualizza Utenti Esistenti</button>
    
    <div id="results"></div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
    async function checkExistingUsers() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p>‚è≥ Caricamento utenti...</p>';
        
        try {
            // Ottieni tutti gli utenti da Firebase Auth
            const auth = firebase.auth();
            const listUsersResult = await auth.getUsers([]); // Ottieni primo batch
            
            resultsDiv.innerHTML = `<h3>üë• ${listUsersResult.users.length} Utenti in Firebase Auth:</h3>`;
            
            listUsersResult.users.forEach(user => {
                resultsDiv.innerHTML += `
                    <div class="user">
                        <strong>${user.email}</strong><br>
                        UID: ${user.uid}<br>
                        Nome: ${user.displayName || 'N/D'}<br>
                        Creato: ${new Date(user.metadata.creationTime).toLocaleDateString()}<br>
                        <button onclick="createUserDoc('${user.uid}', '${user.email}')">
                            ‚ûï Crea Documento Firestore
                        </button>
                    </div>
                `;
            });
            
        } catch (error) {
            resultsDiv.innerHTML = `<p class="error">‚ùå Errore: ${error.message}</p>`;
        }
    }
    
    async function createUserDoc(uid, email) {
        const name = prompt(`Nome per ${email}:`, email.split('@')[0]);
        const department = prompt(`Reparto per ${email}:`, 'Generale');
        
        if (!name) return;
        
        try {
            await firebase.firestore().collection('users').doc(uid).set({
                email: email,
                displayName: name,
                role: 'employee', // Imposta come dipendente
                department: department || 'Generale',
                isActive: true,
                syncedAt: new Date(),
                createdAt: new Date()
            });
            
            alert(`‚úÖ Documento creato per ${email}`);
            checkExistingUsers(); // Aggiorna lista
            
        } catch (error) {
            alert(`‚ùå Errore: ${error.message}`);
        }
    }
    
    async function syncUsers() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p>üîÑ Sincronizzazione in corso...</p>';
        
        try {
            const auth = firebase.auth();
            const listUsersResult = await auth.getUsers([]);
            const users = listUsersResult.users;
            
            let created = 0;
            let errors = 0;
            
            for (const user of users) {
                try {
                    // Controlla se esiste gi√† documento
                    const doc = await firebase.firestore().collection('users').doc(user.uid).get();
                    
                    if (!doc.exists) {
                        // Crea documento
                        await firebase.firestore().collection('users').doc(user.uid).set({
                            email: user.email,
                            displayName: user.displayName || user.email.split('@')[0],
                            role: 'employee', // Default: dipendente
                            department: 'Generale',
                            isActive: true,
                            syncedAt: new Date(),
                            createdAt: new Date(user.metadata.creationTime)
                        });
                        
                        resultsDiv.innerHTML += `<p class="success">‚úÖ ${user.email} sincronizzato</p>`;
                        created++;
                    } else {
                        resultsDiv.innerHTML += `<p>‚ÑπÔ∏è ${user.email} gi√† sincronizzato</p>`;
                    }
                    
                } catch (error) {
                    resultsDiv.innerHTML += `<p class="error">‚ùå ${user.email}: ${error.message}</p>`;
                    errors++;
                }
            }
            
            resultsDiv.innerHTML += `<h3>üéØ Risultato: ${created} creati, ${errors} errori</h3>`;
            
        } catch (error) {
            resultsDiv.innerHTML = `<p class="error">‚ùå Errore sincronizzazione: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>